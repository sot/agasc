<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>agasc.agasc &#8212; Agasc 4.19.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/bootstrap-astropy.css?v=f4f7060c" />
    
    <script src="../../_static/documentation_options.js?v=db6269fb"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../index.html"><span id="logotext1">Ska!</span><span id="logotext2">agasc</span><span id="logotext3"></span></a>
  <ul>
    
    <li><a class="home" title="Homepage" href="https://cxc.cfa.harvard.edu/mta/ASPECT/tool_doc">
        <span id="logotext1">ska</span><span id="logotext2">tools</span>
    </a></li>
    <li><a title="General Index" href="../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../index.html">Agasc 4.19.0 documentation</a>
	 &#187;
      </li>
      <li><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for agasc.agasc</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">numexpr</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tables</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">Chandra.Time</span> <span class="kn">import</span> <span class="n">DateTime</span>
<span class="kn">from</span> <span class="nn">packaging.version</span> <span class="kn">import</span> <span class="n">Version</span>

<span class="kn">from</span> <span class="nn">.healpix</span> <span class="kn">import</span> <span class="n">get_healpix_index_table</span><span class="p">,</span> <span class="n">get_stars_from_healpix_h5</span><span class="p">,</span> <span class="n">is_healpix</span>
<span class="kn">from</span> <span class="nn">.paths</span> <span class="kn">import</span> <span class="n">default_agasc_dir</span>
<span class="kn">from</span> <span class="nn">.supplement.utils</span> <span class="kn">import</span> <span class="n">get_supplement_table</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;sphere_dist&quot;</span><span class="p">,</span>
    <span class="s2">&quot;get_agasc_cone&quot;</span><span class="p">,</span>
    <span class="s2">&quot;get_star&quot;</span><span class="p">,</span>
    <span class="s2">&quot;get_stars&quot;</span><span class="p">,</span>
    <span class="s2">&quot;read_h5_table&quot;</span><span class="p">,</span>
    <span class="s2">&quot;get_agasc_filename&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MAG_CATID_SUPPLEMENT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BAD_CLASS_SUPPLEMENT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;set_supplement_enabled&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SUPPLEMENT_ENABLED_ENV&quot;</span><span class="p">,</span>
    <span class="s2">&quot;write_agasc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TABLE_DTYPE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TableOrder&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;agasc&quot;</span><span class="p">)</span>

<span class="n">SUPPLEMENT_ENABLED_ENV</span> <span class="o">=</span> <span class="s2">&quot;AGASC_SUPPLEMENT_ENABLED&quot;</span>
<span class="n">SUPPLEMENT_ENABLED_DEFAULT</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span>
<span class="n">MAG_CATID_SUPPLEMENT</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">BAD_CLASS_SUPPLEMENT</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">RA_DECS_CACHE</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">COMMON_AGASC_FILE_DOC</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">If ``agasc_file`` is not specified or is None then return either</span>
<span class="s2">    ``default_agasc_dir()/$</span><span class="si">{AGASC_HDF5_FILE}</span><span class="s2">`` if ``$</span><span class="si">{AGASC_HDF5_FILE}</span><span class="s2">`` is defined;</span>
<span class="s2">    or return the latest version of ``proseco_agasc`` in ``default_agasc_dir()``.</span>

<span class="s2">    If ``agasc_file`` ends with the suffix ``.h5`` then it is returned as-is.</span>

<span class="s2">    If ``agasc_file`` ends with ``*`` then the latest version of the matching AGASC file</span>
<span class="s2">    in ``default_agasc_dir()`` is returned. For example, ``proseco_agasc_*`` could return</span>
<span class="s2">    ``$</span><span class="si">{SKA}</span><span class="s2">/data/agasc/proseco_agasc_1p7.h5``.</span>

<span class="s2">    Any other ending for ``agasc_file`` raises a ``ValueError``.</span>

<span class="s2">    The default AGASC directory is the environment variable ``$</span><span class="si">{AGASC_DIR}</span><span class="s2">`` if defined,</span>
<span class="s2">    otherwise ``$</span><span class="si">{SKA}</span><span class="s2">/data/agasc``.&quot;&quot;&quot;</span>

<span class="n">COMMON_DOC</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;By default, stars with available mag estimates or bad star entries</span>
<span class="s2">    in the AGASC supplement are updated in-place in the output ``stars`` Table:</span>

<span class="s2">    - ``MAG_ACA`` and ``MAG_ACA_ERR`` are set according to the supplement.</span>
<span class="s2">    - ``MAG_CATID`` (mag catalog ID) is set to ``agasc.MAG_CATID_SUPPLEMENT``.</span>
<span class="s2">    - If ``COLOR1`` is 0.7 or 1.5 then it is changed to 0.69 or 1.49 respectively.</span>
<span class="s2">      Those particular values do not matter except that they are different from</span>
<span class="s2">      the &quot;status flag&quot; values of 0.7 (no color =&gt; very unreliable mag estimate)</span>
<span class="s2">      or 1.5 (red star =&gt; somewhat unreliable mag estimate) that have special</span>
<span class="s2">      meaning based on deep heritage in the AGASC catalog itself.</span>
<span class="s2">    - If ``AGASC_ID`` is in the supplement bad stars table then CLASS is set to</span>
<span class="s2">      ``agasc.BAD_CLASS_SUPPLEMENT``.</span>

<span class="s2">    To disable the magnitude / bad star updates from the AGASC supplement, see</span>
<span class="s2">    the ``set_supplement_enabled`` context manager / decorator.</span>

<span class="s2">    </span><span class="si">{</span><span class="n">COMMON_AGASC_FILE_DOC</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;return&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;use&quot;</span><span class="p">)</span><span class="si">}</span>

<span class="s2">    The default AGASC supplement file is ``&lt;AGASC_DIR&gt;/agasc_supplement.h5``.</span>
<span class="s2">    &quot;&quot;&quot;</span>


<div class="viewcode-block" id="set_supplement_enabled">
<a class="viewcode-back" href="../../api.html#agasc.agasc.set_supplement_enabled">[docs]</a>
<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">set_supplement_enabled</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator / context manager to temporarily set the default for use of</span>
<span class="sd">    AGASC supplement in query functions.</span>

<span class="sd">    This sets the default for the ``use_supplement`` argument in AGASC function</span>
<span class="sd">    calls if the user does not supply that argument.</span>

<span class="sd">    This is mostly for testing or legacy applications to override the</span>
<span class="sd">    default behavior to use the AGASC supplement star mags when available.</span>

<span class="sd">    Examples::</span>

<span class="sd">      import agasc</span>

<span class="sd">      # Disable use of the supplement for the context block</span>
<span class="sd">      with agasc.set_supplement_enabled(False):</span>
<span class="sd">          aca = proseco.get_aca_catalog(obsid=8008)</span>

<span class="sd">      # Disable use of the supplement for the function</span>
<span class="sd">      @agasc.set_supplement_enabled(False)</span>
<span class="sd">      def test_get_aca_catalog():</span>
<span class="sd">          aca = proseco.get_aca_catalog(obsid=8008)</span>
<span class="sd">          ...</span>

<span class="sd">      # Globally disable use of the supplement everywhere</span>
<span class="sd">      os.environ[agasc.SUPPLEMENT_ENABLED_VAR] = &#39;False&#39;</span>

<span class="sd">    :param value: bool</span>
<span class="sd">        Whether to use the AGASC supplement in the context / decorator</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;value must be bool (True|False)&quot;</span><span class="p">)</span>
    <span class="n">orig</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SUPPLEMENT_ENABLED_ENV</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">SUPPLEMENT_ENABLED_ENV</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">yield</span>

    <span class="k">if</span> <span class="n">orig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">SUPPLEMENT_ENABLED_ENV</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">SUPPLEMENT_ENABLED_ENV</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig</span></div>



<span class="k">class</span> <span class="nc">IdNotFound</span><span class="p">(</span><span class="ne">LookupError</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">InconsistentCatalogError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">RaDec</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agasc_file</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_agasc_file</span> <span class="o">=</span> <span class="n">agasc_file</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">agasc_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agasc_file</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ra</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_ra&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_ra_dec</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ra</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_dec&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_ra_dec</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dec</span>

    <span class="k">def</span> <span class="nf">read_ra_dec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Read the RA and DEC values from the agasc</span>
        <span class="k">with</span> <span class="n">tables</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agasc_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
            <span class="n">ras</span> <span class="o">=</span> <span class="n">h5</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;RA&quot;</span><span class="p">)</span>
            <span class="n">decs</span> <span class="o">=</span> <span class="n">h5</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;DEC&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ras</span><span class="p">,</span> <span class="n">decs</span>


<span class="k">def</span> <span class="nf">get_ra_decs</span><span class="p">(</span><span class="n">agasc_file</span><span class="p">):</span>
    <span class="n">agasc_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">agasc_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">agasc_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">RA_DECS_CACHE</span><span class="p">:</span>
        <span class="n">RA_DECS_CACHE</span><span class="p">[</span><span class="n">agasc_file</span><span class="p">]</span> <span class="o">=</span> <span class="n">RaDec</span><span class="p">(</span><span class="n">agasc_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">RA_DECS_CACHE</span><span class="p">[</span><span class="n">agasc_file</span><span class="p">]</span>


<div class="viewcode-block" id="read_h5_table">
<a class="viewcode-back" href="../../api.html#agasc.agasc.read_h5_table">[docs]</a>
<span class="k">def</span> <span class="nf">read_h5_table</span><span class="p">(</span>
    <span class="n">h5_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="n">tables</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">File</span><span class="p">,</span>
    <span class="n">row0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">row1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">path</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
    <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read HDF5 table from group ``path`` in ``h5_file``.</span>

<span class="sd">    If ``row0`` and ``row1`` are specified then only the rows in that range are read,</span>
<span class="sd">    e.g. ``data[row0:row1]``.</span>

<span class="sd">    If ``cache`` is ``True`` then the data for the last read is cached in memory. The</span>
<span class="sd">    cache key is ``(h5_file, path)`` and only one cache entry is kept. If ``h5_file``</span>
<span class="sd">    is an HDF5 file object then the filename is used as the cache key.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    h5_file : str, Path, tables.file.File</span>
<span class="sd">        Path to the HDF5 file to read or an open HDF5 file from ``tables.open_file``.</span>
<span class="sd">    row0 : int, optional</span>
<span class="sd">        First row to read. Default is None (read from first row).</span>
<span class="sd">    row1 : int, optional</span>
<span class="sd">        Last row to read. Default is None (read to last row).</span>
<span class="sd">    path : str, optional</span>
<span class="sd">        Path to the data table in the HDF5 file. Default is &#39;data&#39;.</span>
<span class="sd">    cache : bool, optional</span>
<span class="sd">        Whether to cache the read data. Default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out : np.ndarray</span>
<span class="sd">        The HDF5 data as a numpy structured array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">h5_file</span><span class="p">,</span> <span class="n">tables</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">File</span><span class="p">):</span>
            <span class="n">h5_file</span> <span class="o">=</span> <span class="n">h5_file</span><span class="o">.</span><span class="n">filename</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">_read_h5_table_cached</span><span class="p">(</span><span class="n">h5_file</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">row0</span><span class="p">:</span><span class="n">row1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">_read_h5_table</span><span class="p">(</span><span class="n">h5_file</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">row0</span><span class="p">,</span> <span class="n">row1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span></div>



<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_read_h5_table_cached</span><span class="p">(</span>
    <span class="n">h5_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">_read_h5_table</span><span class="p">(</span><span class="n">h5_file</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">row0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">row1</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_read_h5_table</span><span class="p">(</span>
    <span class="n">h5_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="n">tables</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">File</span><span class="p">,</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">row0</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">row1</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">h5_file</span><span class="p">,</span> <span class="n">tables</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">File</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">_read_h5_table_from_open_h5_file</span><span class="p">(</span><span class="n">h5_file</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">row0</span><span class="p">,</span> <span class="n">row1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">tables</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">h5_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">_read_h5_table_from_open_h5_file</span><span class="p">(</span><span class="n">h5</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">row0</span><span class="p">,</span> <span class="n">row1</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>  <span class="c1"># Convert to structured ndarray (not recarray)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">_read_h5_table_from_open_h5_file</span><span class="p">(</span><span class="n">h5</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">row0</span><span class="p">,</span> <span class="n">row1</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">h5</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">row0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">row1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<div class="viewcode-block" id="get_agasc_filename">
<a class="viewcode-back" href="../../api.html#agasc.agasc.get_agasc_filename">[docs]</a>
<span class="k">def</span> <span class="nf">get_agasc_filename</span><span class="p">(</span>
    <span class="n">agasc_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">allow_rc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a matching AGASC file name from ``agasc_file``.</span>

<span class="sd">    {common_agasc_file_doc}</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    agasc_file : str, Path, optional</span>
<span class="sd">        AGASC file name (default=None)</span>
<span class="sd">    allow_rc : bool, optional</span>
<span class="sd">        Allow AGASC release candidate files (default=False)</span>
<span class="sd">    version : str, optional</span>
<span class="sd">        Version number to match (e.g. &quot;1p8&quot; or &quot;1p8rc4&quot;, default=None)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Matching AGASC file name</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Setup:</span>

<span class="sd">    &gt;&gt;&gt; from agasc import get_agasc_filename</span>

<span class="sd">    Selecting files in the default AGASC directory:</span>

<span class="sd">    &gt;&gt;&gt; get_agasc_filename()</span>
<span class="sd">    &#39;/Users/aldcroft/ska/data/agasc/proseco_agasc_1p7.h5&#39;</span>
<span class="sd">    &gt;&gt;&gt; get_agasc_filename(&quot;proseco_agasc_*&quot;)</span>
<span class="sd">    &#39;/Users/aldcroft/ska/data/agasc/proseco_agasc_1p7.h5&#39;</span>
<span class="sd">    &gt;&gt;&gt; get_agasc_filename(&quot;proseco_agasc_*&quot;, version=&quot;1p8&quot;, allow_rc=True)</span>
<span class="sd">    &#39;/Users/aldcroft/ska/data/agasc/proseco_agasc_1p8rc4.h5&#39;</span>
<span class="sd">    &gt;&gt;&gt; get_agasc_filename(&quot;agas*&quot;)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">       ...</span>
<span class="sd">    FileNotFoundError: No AGASC files in /Users/aldcroft/ska/data/agasc found matching</span>
<span class="sd">      agas*_?1p([0-9]+).h5</span>

<span class="sd">    Selecting non-default AGASC file in the default directory:</span>

<span class="sd">    &gt;&gt;&gt; os.environ[&quot;AGASC_HDF5_FILE&quot;] = &quot;proseco_agasc_1p6.h5&quot;</span>
<span class="sd">    &gt;&gt;&gt; get_agasc_filename()</span>
<span class="sd">    &#39;/Users/aldcroft/ska/data/agasc/proseco_agasc_1p6.h5&#39;</span>

<span class="sd">    Changing the default AGASC directory:</span>

<span class="sd">    &gt;&gt;&gt; os.environ[&quot;AGASC_DIR&quot;] = &quot;.&quot;</span>
<span class="sd">    &gt;&gt;&gt; get_agasc_filename()</span>
<span class="sd">    &#39;proseco_agasc_1p7.h5&#39;</span>

<span class="sd">    Selecting an arbitrary AGASC file name either directly or with the AGASC_HDF5_FILE</span>
<span class="sd">    environment variable:</span>

<span class="sd">    &gt;&gt;&gt; get_agasc_filename(&quot;any_agasc.h5&quot;)</span>
<span class="sd">    &#39;any_agasc.h5&#39;</span>
<span class="sd">    &gt;&gt;&gt; os.environ[&quot;AGASC_HDF5_FILE&quot;] = &quot;whatever.h5&quot;</span>
<span class="sd">    &gt;&gt;&gt; get_agasc_filename()</span>
<span class="sd">    &#39;/Users/aldcroft/ska/data/agasc/whatever.h5&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">agasc_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;AGASC_HDF5_FILE&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">default_agasc_dir</span><span class="p">()</span> <span class="o">/</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;AGASC_HDF5_FILE&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">agasc_file</span> <span class="o">=</span> <span class="s2">&quot;proseco_agasc_*&quot;</span>

    <span class="n">agasc_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">agasc_file</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">agasc_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.h5&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">agasc_file</span>

    <span class="c1"># Get latest version of file matching agasc_file in the default AGASC dir</span>
    <span class="n">agasc_dir</span> <span class="o">=</span> <span class="n">default_agasc_dir</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">agasc_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;agasc_file must end with &#39;*&#39; or &#39;.h5&#39;&quot;</span><span class="p">)</span>

    <span class="n">agasc_file_re</span> <span class="o">=</span> <span class="n">agasc_file</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;(1p[0-9]+) (rc[1-9][0-9]*)? \.h5$&quot;</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">agasc_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.h5&quot;</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">match</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">agasc_file_re</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_rc</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">version_str</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">rc_str</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">version</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">version_str</span><span class="p">,</span>
                <span class="n">version_str</span> <span class="o">+</span> <span class="n">rc_str</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">Version</span><span class="p">(</span><span class="n">version_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">rc_str</span><span class="p">),</span> <span class="n">path</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">with_version</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; with </span><span class="si">{</span><span class="n">version</span><span class="si">=}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No AGASC files in </span><span class="si">{</span><span class="n">agasc_dir</span><span class="si">}{</span><span class="n">with_version</span><span class="si">}</span><span class="s2"> matching </span><span class="si">{</span><span class="n">agasc_file_re</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="c1"># Get candidate with highest version number. Tuples are sorted lexically starting</span>
    <span class="c1"># by first element, which is the version number here.</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">matches</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>



<div class="viewcode-block" id="sphere_dist">
<a class="viewcode-back" href="../../api.html#agasc.agasc.sphere_dist">[docs]</a>
<span class="k">def</span> <span class="nf">sphere_dist</span><span class="p">(</span><span class="n">ra1</span><span class="p">,</span> <span class="n">dec1</span><span class="p">,</span> <span class="n">ra2</span><span class="p">,</span> <span class="n">dec2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Haversine formula for angular distance on a sphere: more stable at poles.</span>
<span class="sd">    This version uses arctan instead of arcsin and thus does better with sign</span>
<span class="sd">    conventions.  This uses numexpr to speed expression evaluation by a factor</span>
<span class="sd">    of 2 to 3.</span>

<span class="sd">    :param ra1: first RA (deg)</span>
<span class="sd">    :param dec1: first Dec (deg)</span>
<span class="sd">    :param ra2: second RA (deg)</span>
<span class="sd">    :param dec2: second Dec (deg)</span>

<span class="sd">    :returns: angular separation distance (deg)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ra1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">ra1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">ra2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">ra2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">dec1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dec1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">dec2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dec2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="n">numerator</span> <span class="o">=</span> <span class="n">numexpr</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>  <span class="c1"># noqa: F841</span>
        <span class="s2">&quot;sin((dec2 - dec1) / 2) ** 2 + &quot;</span>
        <span class="s2">&quot;cos(dec1) * cos(dec2) * sin((ra2 - ra1) / 2) ** 2&quot;</span>
    <span class="p">)</span>

    <span class="n">dists</span> <span class="o">=</span> <span class="n">numexpr</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s2">&quot;2 * arctan2(numerator ** 0.5, (1 - numerator) ** 0.5)&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">update_color1_column</span><span class="p">(</span><span class="n">stars</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For any stars which have a V-I color (RSV3 &gt; 0) and COLOR1 == 1.5</span>
<span class="sd">    then set COLOR1 = COLOR2 * 0.850.  For such stars the MAG_ACA / MAG_ACA_ERR</span>
<span class="sd">    values are reliable and they should not be flagged with a COLOR1 = 1.5,</span>
<span class="sd">    which generally implies to downstream tools that the mag is unreliable.</span>

<span class="sd">    Also ensure that COLOR2 values that happen to be exactly 1.5 are shifted a bit.</span>

<span class="sd">    The 0.850 factor is because COLOR1 = B-V while COLOR2 = BT-VT.  See</span>
<span class="sd">    https://heasarc.nasa.gov/W3Browse/all/tycho2.html for a reminder of the</span>
<span class="sd">    scaling between the two.</span>

<span class="sd">    This updates ``stars`` in place.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Select red stars that have a reliable mag in AGASC 1.7 and later.</span>
    <span class="n">color15</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;COLOR1&quot;</span><span class="p">],</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;RSV3&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">new_color1</span> <span class="o">=</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;COLOR2&quot;</span><span class="p">][</span><span class="n">color15</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.850</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_color1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Ensure no new COLOR1 are within 0.001 of 1.5, so downstream tests of</span>
        <span class="c1"># COLOR1 == 1.5 or np.isclose(COLOR1, 1.5) will not accidentally succeed.</span>
        <span class="n">fix15</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">new_color1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">)</span>
        <span class="n">new_color1</span><span class="p">[</span><span class="n">fix15</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.499</span>  <span class="c1"># Insignificantly different from 1.50</span>

        <span class="c1"># For stars with a reliable mag, now COLOR1 is really the B-V color.</span>
        <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;COLOR1&quot;</span><span class="p">][</span><span class="n">color15</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_color1</span>


<span class="k">def</span> <span class="nf">add_pmcorr_columns</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add proper-motion corrected columns RA_PMCORR and DEC_PMCORR to Table ``stars``.</span>

<span class="sd">    This computes the PM-corrected RA and Dec of all ``stars`` using the supplied</span>
<span class="sd">    ``date``, which may be a scalar or an array-valued object (np.array or list).</span>

<span class="sd">    The ``stars`` table is updated in-place.</span>

<span class="sd">    :param stars: astropy Table of stars from the AGASC</span>
<span class="sd">    :param date: scalar, list, array of date(s) in DateTime-compatible format</span>
<span class="sd">    :returns: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert date to DateTime ensuring it can broadcast to stars table. Since</span>
    <span class="c1"># DateTime is slow keep it as a scalar if possible.</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">date</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">():</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="p">)))</span>

    <span class="c1"># Compute delta year.  stars[&#39;EPOCH&#39;] is Column, float32. Need to coerce to</span>
    <span class="c1"># ndarray float64 for consistent results between scalar and array cases.</span>
    <span class="n">dyear</span> <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">frac_year</span> <span class="o">-</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;EPOCH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="n">pm_to_degrees</span> <span class="o">=</span> <span class="n">dyear</span> <span class="o">/</span> <span class="p">(</span><span class="mf">3600.0</span> <span class="o">*</span> <span class="mf">1000.0</span><span class="p">)</span>
    <span class="n">dec_pmcorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;PM_DEC&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">9999</span><span class="p">,</span>
        <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;DEC&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;PM_DEC&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">pm_to_degrees</span><span class="p">,</span>
        <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;DEC&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">ra_scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;DEC&quot;</span><span class="p">]))</span>
    <span class="n">ra_pmcorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;PM_RA&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">9999</span><span class="p">,</span>
        <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;RA&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;PM_RA&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">pm_to_degrees</span> <span class="o">/</span> <span class="n">ra_scale</span><span class="p">,</span>
        <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;RA&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># Add the proper-motion corrected columns to table using astropy.table.Table</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_columns</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">Column</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ra_pmcorr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;RA_PMCORR&quot;</span><span class="p">),</span>
            <span class="n">Column</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dec_pmcorr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;DEC_PMCORR&quot;</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>


<div class="viewcode-block" id="get_agasc_cone">
<a class="viewcode-back" href="../../api.html#agasc.agasc.get_agasc_cone">[docs]</a>
<span class="k">def</span> <span class="nf">get_agasc_cone</span><span class="p">(</span>
    <span class="n">ra</span><span class="p">,</span>
    <span class="n">dec</span><span class="p">,</span>
    <span class="n">radius</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
    <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">agasc_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">pm_filter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">fix_color1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">use_supplement</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get AGASC catalog entries within ``radius`` degrees of ``ra``, ``dec``.</span>

<span class="sd">    The star positions are corrected for proper motion using the ``date``</span>
<span class="sd">    argument, which defaults to the current date if not supplied.  The</span>
<span class="sd">    corrected positions are available in the ``RA_PMCORR`` and ``DEC_PMCORR``</span>
<span class="sd">    columns, respectively.</span>

<span class="sd">    {common_doc}</span>

<span class="sd">    Example::</span>

<span class="sd">      &gt;&gt;&gt; import agasc</span>
<span class="sd">      &gt;&gt;&gt; stars = agasc.get_agasc_cone(10.0, 20.0, 1.5)</span>
<span class="sd">      &gt;&gt;&gt; plt.plot(stars[&#39;RA&#39;], stars[&#39;DEC&#39;], &#39;.&#39;)</span>

<span class="sd">    :param ra: RA (deg)</span>
<span class="sd">    :param dec: Declination (deg)</span>
<span class="sd">    :param radius: Cone search radius (deg)</span>
<span class="sd">    :param date: Date for proper motion (default=Now)</span>
<span class="sd">    :param agasc_file: AGASC file (optional)</span>
<span class="sd">    :param pm_filter: Use PM-corrected positions in filtering</span>
<span class="sd">    :param fix_color1: set COLOR1=COLOR2 * 0.85 for stars with V-I color</span>
<span class="sd">    :param use_supplement: Use estimated mag from AGASC supplement where available</span>
<span class="sd">        (default=value of AGASC_SUPPLEMENT_ENABLED env var, or True if not defined)</span>
<span class="sd">    :param cache: Cache the AGASC data in memory (default=False)</span>

<span class="sd">    :returns: astropy Table of AGASC entries</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">agasc_file</span> <span class="o">=</span> <span class="n">get_agasc_filename</span><span class="p">(</span><span class="n">agasc_file</span><span class="p">)</span>

    <span class="n">get_stars_func</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">get_stars_from_healpix_h5</span>
        <span class="k">if</span> <span class="n">is_healpix</span><span class="p">(</span><span class="n">agasc_file</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">get_stars_from_dec_sorted_h5</span>
    <span class="p">)</span>
    <span class="c1"># Possibly expand initial radius to allow for slop due proper motion</span>
    <span class="n">rad_pm</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.1</span> <span class="k">if</span> <span class="n">pm_filter</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">)</span>

    <span class="n">stars</span> <span class="o">=</span> <span class="n">get_stars_func</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">rad_pm</span><span class="p">,</span> <span class="n">agasc_file</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
    <span class="n">add_pmcorr_columns</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fix_color1</span><span class="p">:</span>
        <span class="n">update_color1_column</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span>

    <span class="c1"># Final filtering using proper-motion corrected positions</span>
    <span class="k">if</span> <span class="n">pm_filter</span><span class="p">:</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="n">sphere_dist</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;RA_PMCORR&quot;</span><span class="p">],</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;DEC_PMCORR&quot;</span><span class="p">])</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">dists</span> <span class="o">&lt;=</span> <span class="n">radius</span>
        <span class="n">stars</span> <span class="o">=</span> <span class="n">stars</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>

    <span class="n">update_from_supplement</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="n">use_supplement</span><span class="p">)</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;agasc_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agasc_file</span>

    <span class="k">return</span> <span class="n">stars</span></div>



<span class="k">def</span> <span class="nf">get_stars_from_dec_sorted_h5</span><span class="p">(</span>
    <span class="n">ra</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">dec</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">agasc_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Table</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a table of stars within a given radius of a given RA and Dec.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ra : float</span>
<span class="sd">        The right ascension of the center of the search radius, in degrees.</span>
<span class="sd">    dec : float</span>
<span class="sd">        The declination of the center of the search radius, in degrees.</span>
<span class="sd">    radius : float</span>
<span class="sd">        The radius of the search circle, in degrees.</span>
<span class="sd">    agasc_file : str or Path</span>
<span class="sd">        The path to the AGASC HDF5 file.</span>
<span class="sd">    cache : bool, optional</span>
<span class="sd">        Whether to cache the AGASC data in memory. Default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    stars : astropy.table.Table</span>
<span class="sd">        A structured ndarray of stars within the search radius, sorted by declination.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ra_decs</span> <span class="o">=</span> <span class="n">get_ra_decs</span><span class="p">(</span><span class="n">agasc_file</span><span class="p">)</span>
    <span class="n">idx0</span><span class="p">,</span> <span class="n">idx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">ra_decs</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="p">[</span><span class="n">dec</span> <span class="o">-</span> <span class="n">radius</span><span class="p">,</span> <span class="n">dec</span> <span class="o">+</span> <span class="n">radius</span><span class="p">])</span>

    <span class="n">dists</span> <span class="o">=</span> <span class="n">sphere_dist</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">ra_decs</span><span class="o">.</span><span class="n">ra</span><span class="p">[</span><span class="n">idx0</span><span class="p">:</span><span class="n">idx1</span><span class="p">],</span> <span class="n">ra_decs</span><span class="o">.</span><span class="n">dec</span><span class="p">[</span><span class="n">idx0</span><span class="p">:</span><span class="n">idx1</span><span class="p">])</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="n">dists</span> <span class="o">&lt;=</span> <span class="n">radius</span>

    <span class="n">stars</span> <span class="o">=</span> <span class="n">read_h5_table</span><span class="p">(</span><span class="n">agasc_file</span><span class="p">,</span> <span class="n">row0</span><span class="o">=</span><span class="n">idx0</span><span class="p">,</span> <span class="n">row1</span><span class="o">=</span><span class="n">idx1</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">)</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="n">ok</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">stars</span>


<div class="viewcode-block" id="get_star">
<a class="viewcode-back" href="../../api.html#agasc.agasc.get_star">[docs]</a>
<span class="k">def</span> <span class="nf">get_star</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">agasc_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fix_color1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_supplement</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get AGASC catalog entry for star with requested id.</span>

<span class="sd">    {common_doc}</span>

<span class="sd">    Example::</span>

<span class="sd">      &gt;&gt;&gt; import agasc</span>
<span class="sd">      &gt;&gt;&gt; star = agasc.get_star(636629880)</span>
<span class="sd">      &gt;&gt;&gt; for name in star.colnames:</span>
<span class="sd">      ...     print &#39;{{:12s}} : {{}}&#39;.format(name, star[name])</span>
<span class="sd">      AGASC_ID     : 636629880</span>
<span class="sd">      RA           : 125.64184</span>
<span class="sd">      DEC          : -4.23235</span>
<span class="sd">      POS_ERR      : 300</span>
<span class="sd">      POS_CATID    : 6</span>
<span class="sd">      EPOCH        : 1983.0</span>
<span class="sd">      PM_RA        : -9999</span>
<span class="sd">      PM_DEC       : -9999</span>
<span class="sd">      PM_CATID     : 0</span>
<span class="sd">      PLX          : -9999</span>
<span class="sd">      PLX_ERR      : -9999</span>
<span class="sd">      PLX_CATID    : 0</span>
<span class="sd">      MAG_ACA      : 12.1160011292</span>
<span class="sd">      MAG_ACA_ERR  : 45</span>
<span class="sd">      CLASS        : 0</span>
<span class="sd">      MAG          : 13.2700004578</span>
<span class="sd">      ...</span>

<span class="sd">    :param id: AGASC id</span>
<span class="sd">    :param date: Date for proper motion (default=Now)</span>
<span class="sd">    :param fix_color1: set COLOR1=COLOR2 * 0.85 for stars with V-I color (default=True)</span>
<span class="sd">    :param use_supplement: Use estimated mag from AGASC supplement where available</span>
<span class="sd">        (default=value of AGASC_SUPPLEMENT_ENABLED env var, or True if not defined)</span>
<span class="sd">    :returns: astropy Table Row of entry for id</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">agasc_file</span> <span class="o">=</span> <span class="n">get_agasc_filename</span><span class="p">(</span><span class="n">agasc_file</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">tables</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">agasc_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="n">h5</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">data</span>
        <span class="n">id_rows</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">.</span><span class="n">read_where</span><span class="p">(</span><span class="s2">&quot;(AGASC_ID == </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">id_rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InconsistentCatalogError</span><span class="p">(</span>
            <span class="s2">&quot;More than one entry found for </span><span class="si">{}</span><span class="s2"> in AGASC&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">id_rows</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">id_rows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">IdNotFound</span><span class="p">()</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">id_rows</span><span class="p">)</span>
    <span class="n">add_pmcorr_columns</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fix_color1</span><span class="p">:</span>
        <span class="n">update_color1_column</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">update_from_supplement</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">use_supplement</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>



<span class="k">def</span> <span class="nf">_get_rows_read_where</span><span class="p">(</span><span class="n">ids_1d</span><span class="p">,</span> <span class="n">dates_1d</span><span class="p">,</span> <span class="n">agasc_file</span><span class="p">):</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="n">tables</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">agasc_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="n">h5</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">data</span>
        <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">_date</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ids_1d</span><span class="p">,</span> <span class="n">dates_1d</span><span class="p">):</span>
            <span class="n">id_rows</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">.</span><span class="n">read_where</span><span class="p">(</span><span class="s2">&quot;(AGASC_ID == </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">id_rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InconsistentCatalogError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;More than one entry found for </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2"> in AGASC&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">id_rows</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">id_rows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">IdNotFound</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No entry found for </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2"> in AGASC&quot;</span><span class="p">)</span>

            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">id_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">rows</span>


<span class="k">def</span> <span class="nf">_get_rows_read_entire</span><span class="p">(</span><span class="n">ids_1d</span><span class="p">,</span> <span class="n">dates_1d</span><span class="p">,</span> <span class="n">agasc_file</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">tables</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">agasc_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="n">h5</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span>

    <span class="n">agasc_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">agasc_id</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">agasc_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="s2">&quot;AGASC_ID&quot;</span><span class="p">])}</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">agasc_id</span><span class="p">,</span> <span class="n">_date</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ids_1d</span><span class="p">,</span> <span class="n">dates_1d</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">agasc_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agasc_idx</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">IdNotFound</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No entry found for </span><span class="si">{</span><span class="n">agasc_id</span><span class="si">}</span><span class="s2"> in AGASC&quot;</span><span class="p">)</span>

        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="n">agasc_idx</span><span class="p">[</span><span class="n">agasc_id</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">rows</span>


<div class="viewcode-block" id="get_stars">
<a class="viewcode-back" href="../../api.html#agasc.agasc.get_stars">[docs]</a>
<span class="k">def</span> <span class="nf">get_stars</span><span class="p">(</span>
    <span class="n">ids</span><span class="p">,</span>
    <span class="n">agasc_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">method_threshold</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
    <span class="n">fix_color1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">use_supplement</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get AGASC catalog entries for star ``ids`` at ``dates``.</span>

<span class="sd">    The input ``ids`` and ``dates`` are broadcast together for the output shape</span>
<span class="sd">    (though note that the result is flattened in the end). If both are scalar</span>
<span class="sd">    inputs then the output is a Table Row, otherwise the output is a Table.</span>

<span class="sd">    This function has two possible methods for getting stars, either by using</span>
<span class="sd">    the HDF5 ``tables.read_where()`` function to get one star at a time from the</span>
<span class="sd">    HDF5 file, or by reading the entire table into memory and doing the search</span>
<span class="sd">    by making a dict index by AGASC ID. Tests indicate that the latter is faster</span>
<span class="sd">    for about 5000 or more stars, so this function will read the entire AGASC if</span>
<span class="sd">    the number of stars is greater than ``method_threshold``.</span>

<span class="sd">    Unlike the similar ``get_star`` function, this adds a ``DATE`` column</span>
<span class="sd">    indicating the date at which the star coordinates (RA_PMCORR, DEC_PMCORR)</span>
<span class="sd">    are computed.</span>

<span class="sd">    {common_doc}</span>

<span class="sd">    Example::</span>
<span class="sd">      &gt;&gt;&gt; import agasc</span>
<span class="sd">      &gt;&gt;&gt; star = agasc.get_stars(636629880)</span>
<span class="sd">      &gt;&gt;&gt; for name in star.colnames:</span>
<span class="sd">      ...     print &#39;{{:12s}} : {{}}&#39;.format(name, star[name])</span>
<span class="sd">      AGASC_ID     : 636629880</span>
<span class="sd">      RA           : 125.64184</span>
<span class="sd">      DEC          : -4.23235</span>
<span class="sd">      POS_ERR      : 300</span>
<span class="sd">      POS_CATID    : 6</span>
<span class="sd">      EPOCH        : 1983.0</span>
<span class="sd">      PM_RA        : -9999</span>
<span class="sd">      PM_DEC       : -9999</span>
<span class="sd">      PM_CATID     : 0</span>
<span class="sd">      PLX          : -9999</span>
<span class="sd">      PLX_ERR      : -9999</span>
<span class="sd">      PLX_CATID    : 0</span>
<span class="sd">      MAG_ACA      : 12.1160011292</span>
<span class="sd">      MAG_ACA_ERR  : 45</span>
<span class="sd">      CLASS        : 0</span>
<span class="sd">      MAG          : 13.2700004578</span>
<span class="sd">      ...</span>

<span class="sd">    :param ids: AGASC ids (scalar or array)</span>
<span class="sd">    :param dates: Dates for proper motion (scalar or array) (default=Now)</span>
<span class="sd">    :param fix_color1: set COLOR1=COLOR2 * 0.85 for stars with V-I color (default=True)</span>
<span class="sd">    :param use_supplement: Use estimated mag from AGASC supplement where available</span>
<span class="sd">        (default=value of AGASC_SUPPLEMENT_ENABLED env var, or True if not defined)</span>
<span class="sd">    :returns: astropy Table of AGASC entries, or Table Row of one entry for scalar input</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">agasc_file</span> <span class="o">=</span> <span class="n">get_agasc_filename</span><span class="p">(</span><span class="n">agasc_file</span><span class="p">)</span>

    <span class="n">dates_in</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
    <span class="n">dates_is_scalar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dates_in</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">()</span>

    <span class="n">ids</span><span class="p">,</span> <span class="n">dates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_arrays</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">dates_in</span><span class="p">)</span>
    <span class="n">ids_1d</span><span class="p">,</span> <span class="n">dates_1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids_1d</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">method_threshold</span><span class="p">:</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">_get_rows_read_where</span><span class="p">(</span><span class="n">ids_1d</span><span class="p">,</span> <span class="n">dates_1d</span><span class="p">,</span> <span class="n">agasc_file</span><span class="p">)</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;tables_read_where&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">_get_rows_read_entire</span><span class="p">(</span><span class="n">ids_1d</span><span class="p">,</span> <span class="n">dates_1d</span><span class="p">,</span> <span class="n">agasc_file</span><span class="p">)</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;read_entire_agasc&quot;</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

    <span class="c1"># Define a temporary attribute indicating get_stars method, mostly for testing</span>
    <span class="n">t</span><span class="o">.</span><span class="n">get_stars_method</span> <span class="o">=</span> <span class="n">method</span>

    <span class="n">add_pmcorr_columns</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dates_in</span> <span class="k">if</span> <span class="n">dates_is_scalar</span> <span class="k">else</span> <span class="n">dates</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fix_color1</span><span class="p">:</span>
        <span class="n">update_color1_column</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dates</span>

    <span class="n">update_from_supplement</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">use_supplement</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">t</span> <span class="k">if</span> <span class="n">ids</span><span class="o">.</span><span class="n">shape</span> <span class="k">else</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>



<span class="c1"># Interpolate common docs into function docstrings. Using f-string interpolation in the</span>
<span class="c1"># docstring itself does not work.</span>
<span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">get_stars</span><span class="p">,</span> <span class="n">get_star</span><span class="p">,</span> <span class="n">get_agasc_cone</span><span class="p">:</span>
    <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">common_doc</span><span class="o">=</span><span class="n">COMMON_DOC</span><span class="p">)</span>
<span class="n">get_agasc_filename</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">get_agasc_filename</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">common_agasc_file_doc</span><span class="o">=</span><span class="n">COMMON_AGASC_FILE_DOC</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">update_from_supplement</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="n">use_supplement</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update mag, color1 and class information from AGASC supplement in ``stars``.</span>

<span class="sd">    Stars with available mag estimates in the AGASC supplement are updated</span>
<span class="sd">    in-place in the input ``stars`` Table:</span>

<span class="sd">    - ``MAG_ACA`` and ``MAG_ACA_ERR`` are set according to the supplement.</span>
<span class="sd">    - ``MAG_CATID`` (mag catalog ID) is set to ``MAG_CATID_SUPPLEMENT``.</span>
<span class="sd">    - If COLOR1 is 0.7 or 1.5 then it is changed to 0.69 or 1.49 respectively.</span>
<span class="sd">      Those particular values do not matter except that they are different from</span>
<span class="sd">      the &quot;status flag&quot; values of 0.7 (no color =&gt; very unreliable mag estimate)</span>
<span class="sd">      or 1.5 (red star =&gt; somewhat unreliable mag estimate) that have special</span>
<span class="sd">      meaning based on deep heritage in the AGASC catalog itself.</span>

<span class="sd">    Stars which are in the bad stars table are updated as follows:</span>

<span class="sd">    - ``CLASS = BAD_CLASS_SUPPLEMENT``</span>

<span class="sd">    Whether to actually apply the update is set by a combination of the</span>
<span class="sd">    ``use_supplement`` argument, which has priority, and the</span>
<span class="sd">    ``AGASC_SUPPLEMENT_ENABLED`` environment variable.</span>

<span class="sd">    :param stars: astropy.table.Table of stars</span>
<span class="sd">    :param use_supplement: bool, None</span>
<span class="sd">        Use the supplement (default=None, see above)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">use_supplement</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">supplement_enabled_env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">SUPPLEMENT_ENABLED_ENV</span><span class="p">,</span> <span class="n">SUPPLEMENT_ENABLED_DEFAULT</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">supplement_enabled_env</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;True&quot;</span><span class="p">,</span> <span class="s2">&quot;False&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">SUPPLEMENT_ENABLED_ENV</span><span class="si">}</span><span class="s1"> env var must be either &quot;True&quot; or &quot;False&quot; &#39;</span>
                <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="n">supplement_enabled_env</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">supplement_enabled</span> <span class="o">=</span> <span class="n">supplement_enabled_env</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">supplement_enabled</span> <span class="o">=</span> <span class="n">use_supplement</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">supplement_enabled</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">set_star</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set star[name] = value if ``name`` is a column in the table&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">star</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># Get estimate mags and errs from supplement as a dict of dict</span>
    <span class="c1"># agasc_id : {mag_aca: .., mag_aca_err: ..}.</span>
    <span class="n">supplement_mags</span> <span class="o">=</span> <span class="n">get_supplement_table</span><span class="p">(</span><span class="s2">&quot;mags&quot;</span><span class="p">,</span> <span class="n">agasc_dir</span><span class="o">=</span><span class="n">default_agasc_dir</span><span class="p">())</span>
    <span class="n">supplement_mags_index</span> <span class="o">=</span> <span class="n">supplement_mags</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

    <span class="c1"># Get bad stars as {agasc_id: {source: ..}}</span>
    <span class="n">bad_stars</span> <span class="o">=</span> <span class="n">get_supplement_table</span><span class="p">(</span><span class="s2">&quot;bad&quot;</span><span class="p">,</span> <span class="n">agasc_dir</span><span class="o">=</span><span class="n">default_agasc_dir</span><span class="p">())</span>
    <span class="n">bad_stars_index</span> <span class="o">=</span> <span class="n">bad_stars</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">star</span> <span class="ow">in</span> <span class="n">stars</span><span class="p">:</span>
        <span class="n">agasc_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">star</span><span class="p">[</span><span class="s2">&quot;AGASC_ID&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">agasc_id</span> <span class="ow">in</span> <span class="n">supplement_mags_index</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">supplement_mags_index</span><span class="p">[</span><span class="n">agasc_id</span><span class="p">]</span>
            <span class="n">mag_est</span> <span class="o">=</span> <span class="n">supplement_mags</span><span class="p">[</span><span class="s2">&quot;mag_aca&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">mag_est_err</span> <span class="o">=</span> <span class="n">supplement_mags</span><span class="p">[</span><span class="s2">&quot;mag_aca_err&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>

            <span class="n">set_star</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="s2">&quot;MAG_ACA&quot;</span><span class="p">,</span> <span class="n">mag_est</span><span class="p">)</span>
            <span class="c1"># Mag err is stored as int16 in units of 0.01 mag. Use same convention here.</span>
            <span class="n">set_star</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="s2">&quot;MAG_ACA_ERR&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">mag_est_err</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
            <span class="n">set_star</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="s2">&quot;MAG_CATID&quot;</span><span class="p">,</span> <span class="n">MAG_CATID_SUPPLEMENT</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;COLOR1&quot;</span> <span class="ow">in</span> <span class="n">stars</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="n">color1</span> <span class="o">=</span> <span class="n">star</span><span class="p">[</span><span class="s2">&quot;COLOR1&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">color1</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">color1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">):</span>
                    <span class="n">star</span><span class="p">[</span><span class="s2">&quot;COLOR1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color1</span> <span class="o">-</span> <span class="mf">0.01</span>

        <span class="k">if</span> <span class="n">agasc_id</span> <span class="ow">in</span> <span class="n">bad_stars_index</span><span class="p">:</span>
            <span class="n">set_star</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="s2">&quot;CLASS&quot;</span><span class="p">,</span> <span class="n">BAD_CLASS_SUPPLEMENT</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">write_healpix_index_table</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">healpix_index</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span> <span class="n">nside</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a HEALPix index table to an HDF5 file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        The path to the HDF5 file to write to.</span>
<span class="sd">    healpix_index : astropy.table.Table</span>
<span class="sd">        The HEALPix index table to write.</span>
<span class="sd">    nside : int</span>
<span class="sd">        The NSIDE parameter used to generate the HEALPix index.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">healpix_index_np</span> <span class="o">=</span> <span class="n">healpix_index</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">tables</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
        <span class="n">h5</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;healpix_index&quot;</span><span class="p">,</span> <span class="n">healpix_index_np</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;HEALPix index&quot;</span><span class="p">)</span>
        <span class="n">h5</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">healpix_index</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;nside&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nside</span>


<span class="n">TABLE_DTYPE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;AGASC_ID&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;RA&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;DEC&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;POS_ERR&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;POS_CATID&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;EPOCH&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;PM_RA&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;PM_DEC&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;PM_CATID&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;PLX&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;PLX_ERR&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;PLX_CATID&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;MAG_ACA&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;MAG_ACA_ERR&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;CLASS&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;MAG&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;MAG_ERR&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;MAG_BAND&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;MAG_CATID&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;COLOR1&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;COLOR1_ERR&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;C1_CATID&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;COLOR2&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;COLOR2_ERR&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;C2_CATID&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;RSV1&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;RSV2&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;RSV3&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;VAR&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;VAR_CATID&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;ASPQ1&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;ASPQ2&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;ASPQ3&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;ACQQ1&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;ACQQ2&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;ACQQ3&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;ACQQ4&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;ACQQ5&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;ACQQ6&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;XREF_ID1&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;XREF_ID2&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;XREF_ID3&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;XREF_ID4&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;XREF_ID5&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;RSV4&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;RSV5&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;RSV6&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="sd">&quot;&quot;&quot;Standard dtype for AGASC table.&quot;&quot;&quot;</span>


<div class="viewcode-block" id="TableOrder">
<a class="viewcode-back" href="../../api.html#agasc.agasc.TableOrder">[docs]</a>
<span class="k">class</span> <span class="nc">TableOrder</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enumeration type to specify the AGASC table ordering:</span>

<span class="sd">    - TableOrder.NONE. The stars are not sorted.</span>
<span class="sd">    - TableOrder.HEALPIX. The stars are sorted using a HEALPix index.</span>
<span class="sd">    - TableOrder.DEC. The stars are sorted by declination.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">NONE</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">DEC</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">HEALPIX</span> <span class="o">=</span> <span class="mi">3</span></div>



<div class="viewcode-block" id="write_agasc">
<a class="viewcode-back" href="../../api.html#agasc.agasc.write_agasc">[docs]</a>
<span class="k">def</span> <span class="nf">write_agasc</span><span class="p">(</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stars</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">nside</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">TableOrder</span><span class="o">.</span><span class="n">HEALPIX</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write AGASC stars to a new HDF5 file.</span>

<span class="sd">    The table is coerced to the correct dtype if necessary (:any:`TABLE_DTYPE`).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        The path to the HDF5 file to write to.</span>
<span class="sd">    stars : np.ndarray</span>
<span class="sd">        The AGASC stars to write.</span>
<span class="sd">    version : str</span>
<span class="sd">        The AGASC version number. This sets an attribute in the table.</span>
<span class="sd">    nside : int, optional</span>
<span class="sd">        The HEALPix NSIDE parameter to use for the HEALPix index table.</span>
<span class="sd">        Default is 64.</span>
<span class="sd">    order : :any:`TableOrder`, optional</span>
<span class="sd">        The order of the stars in the AGASC file (Default is TableOrder.HEALPIX).</span>
<span class="sd">        The options are:</span>

<span class="sd">            - TableOrder.HEALPIX. The stars are sorted using a HEALPix index.</span>
<span class="sd">            - TableOrder.DEC. The stars are sorted by declination.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">stars</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">TABLE_DTYPE</span><span class="p">:</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">TABLE_DTYPE</span><span class="o">.</span><span class="n">names</span>
        <span class="n">missing_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">stars</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing keys in stars: </span><span class="si">{</span><span class="n">missing_keys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">stars</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">stars</span><span class="p">)[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">TABLE_DTYPE</span><span class="p">)</span>

    <span class="k">match</span> <span class="n">order</span><span class="p">:</span>
        <span class="k">case</span> <span class="n">TableOrder</span><span class="o">.</span><span class="n">DEC</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sorting on DEC column&quot;</span><span class="p">)</span>
            <span class="n">idx_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;DEC&quot;</span><span class="p">])</span>
        <span class="k">case</span> <span class="n">TableOrder</span><span class="o">.</span><span class="n">HEALPIX</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Creating healpix_index table for nside=</span><span class="si">{</span><span class="n">nside</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;and sorting by healpix index&quot;</span>
            <span class="p">)</span>
            <span class="n">healpix_index</span><span class="p">,</span> <span class="n">idx_sort</span> <span class="o">=</span> <span class="n">get_healpix_index_table</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="n">nside</span><span class="p">)</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">stars</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">idx_sort</span><span class="p">)</span>

    <span class="n">_write_agasc</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">stars</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="n">TableOrder</span><span class="o">.</span><span class="n">HEALPIX</span><span class="p">:</span>
        <span class="n">write_healpix_index_table</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">healpix_index</span><span class="p">,</span> <span class="n">nside</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_write_agasc</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">stars</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Do the actual writing to HDF file.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">tables</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">h5</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">stars</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;AGASC </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">version</span>
        <span class="n">data</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Creating AGASC_ID index&quot;</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">AGASC_ID</span><span class="o">.</span><span class="n">create_csindex</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Flush and close </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">h5</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


<form action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2013, Jean Connelly, Tom Aldcroft.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 7.2.6. &nbsp;
  </p>
</footer>
  </body>
</html>